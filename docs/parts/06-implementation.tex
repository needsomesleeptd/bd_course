\chapter{Технологическая часть}
В данной части рассматривается выбор средств реализации, описывается реализация алгоритмов и построенных схем.

\section{Выбор СУБД}
В соответствии с приведенной диаграммой сущность---связь необходимо организовать хранение следующих типов данных.
\begin{enumerate}
	\item Файлы отчетов и результатов проверки работ студентов.
	\item Выделенные фрагменты и их описание.
	\item Информацию о студентах, достижениях, комментариях.
	\item Хранение файлов журнала системы (англ. logs)~\cite{kuznecov-db}.
\end{enumerate}
Также в выбранной СУБД должна быть возможность создания ролей и выдача прав в соответствии с ними.
В конструкторском разделе была определена реляционная модель баз данных для хранения информации в системе, файлы отчетов и результатов проверки будут хранится в файловой системе сервера, мета информация для их получения будет также хранится в базе данных системы.

Рассмотрим наиболее популярные реляционные СУБД~\cite{sql_popular}:
\begin{enumerate}
	\item PostgreSQL~\cite{postgres,postgres_pro_cert}.
	\item MySQL~\cite{ms_sql_server}.
	\item MS SQL~\cite{mysql}.
\end{enumerate}

Сравнение будет произведено по следующим критериям:
\begin{enumerate}
	\item Доступность в лицензии Российской Федерации.
	\item Популярность среди разработчиков.
	\item Наличие ролевой модели.
\end{enumerate}


\subsection{Доступность лицензии}
PostgreSQL является является ПО с открытым исходным кодом, ввиду чего существуют несколько версий данного продукта~\cite{postgres}. На базе PostgreSQL была разработана СУБД Postgres Pro Certified,которая сертифицирована ФСТЭК РФ~\cite{postgres_pro_cert}.Сертификация позволяет использовать ее для хранения информации:
\begin{enumerate}
	\item В значимых объектах критической информационной инфраструктуры 1 категории, в государственных информационных системах 1 класса защищенности;
	\item В автоматизированных системах управления производственными и технологическими процессами 1 класса защищенности;
	\item В информационных системах персональных данных при необходимости обеспечения 1 уровня защищенности персональных данных;
	\item В информационных системах общего пользования II класса.
\end{enumerate}

MS SQL (Microsoft SQL Server) является продуктом компании Microsoft,в 2022 году ФСТЭК принял решение об отзыве сертификатов	 данной компании~\cite{ms_sql_cert}.

MySQL не является сертифицированном продуктом на территории Российской Федерации.




Все 3 СУБД имеют ролевую модель данных\cite{ms_sql_roles,postgres,mysql_roles}.
Стоит отметить что наибольший процент использования СУБД  имеет MS~SQL, затем идет PostgreSQl, затем MySQL~\cite{sql_popular}.

В результате анализа полученных данных, была получена таблица~\ref{t:dbms_cmp}.
\begin{table}[ht]
	\centering
	\caption{Сравнение наиболее популярных СУБД}
	\begin{tabular}{|l|c|c|c|}
		\hline
		\diagbox[width=15em]{Критерии сравнения}{СУБД}&  PostgreSQL & MySQL & MS SQL \\ \hline
		Уровень защищенности & 1 & нет & нет \\ \hline
		Частота практического использования & 2 & 3 & 1 \\ \hline
		Наличие ролевой модели & да & да & да \\ \hline
	\end{tabular}
	\label{t:dbms_cmp}
\end{table}
В таблице~\ref{t:dbms_cmp} числа в строке <<Частота практического использования>> обозначают порядковый номер СУБД с точки зрения практического внедрения или использования~\cite{sql_popular}.

Таким образом для решения поставленной задачи стоит выбрать СУБД PostgreSQL, так как занимает второе место по популярности  и имеет сертификацию 1-го уровня защищенности(см. таблицу~\ref{t:dbms_cmp}).

Также необходимо реализовать хранения файлов журнала приложения, для этого было решено использовать СУБД временных рядов. Так как InfluxDB поддерживает использование InfluxQL подобного SQL, а также является ПО с открытым исходным кодом стоит использовать ее для хранения файлов журнала~\cite{time_db}.

\section{Выбор средств реализации}
Для реализации описанного функционала был выбран язык программирования GO, в силу следующих причин:
\begin{enumerate}
	\item Существует библиотека для данного языка, позволяющая реализовывать запросы к базам данных на уровне языка~\cite{gorm}.
	\item Язык поддерживает создание интерфейсов и структур, что позволяет выделить основные объекты и сущности при разработке и использовать их при реализации~\cite{go_interface}.
	\item GO имеет обширную документацию, в которой в каждом описываемом модуле (пакете) приведены примеры реализации и использования объектов модуля~\cite{go_package}.
\end{enumerate}

Для реализации нейронной сети был выбран язык Python, так как онн поддерживает фреймворк PyTorch, использование которого достаточно для решения задачи детекции основных частей отчета~\cite{pytorch}.

\section{Схемы базы данных}
Схема реализованной базы данных представлена на рисунке~\ref{img:BD_SCHEME}, PK --- обозначают первичные ключи базы данных, FK --- вторичные.
\includeimage
{BD_SCHEME} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{H} % Положение рисунка (см. figure из пакета float)
{1\textwidth} % Ширина рисунка
{Схема алгоритма триггера после добавления в таблицу метаданных отчетов} % Подпись рисунка

\section{Реализация создания отношений}
В листинге~\ref{lst:create.sql} приведена реализация создания отношений.
Отношения обозначают соответственно:
\begin{enumerate}
	\item documents --- сущность документа;
	\item markup\_types --- сущность типов фрагмента отчета;
	\item markups --- сущность выделенного фрагмента;
	\item users --- сущность пользователя (контроллера, админа или студента);
	\item document\_queues --- сущность элемента очереди отчета для проверки;
	\item comments --- сущность комментариев к отчету;
	\item achievments --- сущность достижения.
\end{enumerate}


\section{Реализация функций}
В листинге~\ref{lst:functions.sql} приведены реализации спроектированных функций. Функция \texttt{getTasksReady} получает все документы из очереди, которые готовы к проверке и не были проверены до этого.

\section{Реализация триггеров}
В листинге~\ref{lst:triggers.sql} приведены реализации спроектированных триггеров. Триггер \texttt{addToQueue}, при добавлении метаданных документа, в случае если в имени файла нет подстрока VIP и он не был уже проверен добавляет документ в очередь для проверки.

\section{Тестирование разработанных функций базы данных}
В данной части работы будет произведено тестирование разработанных функций и триггеров базы данных.

Рассмотрим следующие варианты использования разработанной процедуры \texttt{getTasksReady}:
\begin{enumerate}
	\item Получение всех записей в таблице при передачи значения \texttt{NULL}.
	\item Получение записей в таблице с соответствующим статусом (в данной системе статусы принимают значения 0--2, где 0~----~работа пользователя не проверена, 1~---~работа пользователя проверена, 2~---~ошибка в работе системы при проверке).
\end{enumerate}

Состояние исходного отношения для тестирования представлено в таблице~\ref{t:document_queues_test_def}:
\begin{table}[H]
	\centering
	\caption{Исходное состояние таблицы для тестирования}
	\label{t:document_queues_test_def}
	\begin{tabularx}{\textwidth}{|c|Z|c|}
		\hline
		\textbf{ID} & \textbf{doc\_id} & \textbf{status}  \\ \hline
		1 & 710eb9fc-1118-4a66-837e-8e3d2d027a68 & 0 \\ \hline
		2 & 710eb9fc-1118-4a66-837e-8e3d2d027a67 & 0 \\ \hline
		3 & 710eb9fc-1118-4a66-837e-8e3d2d027a65 & 0 \\ \hline
		4 & 710eb9fc-1118-4a66-837e-8e3d2d027a61 & 0 \\ \hline
		5 & 5d92a123-b3a8-4f6d-b449-dc07913f60be & 0 \\ \hline 
		7 & df6286ba-9993-4a15-928b-2ef0652dd699 & 1 \\ \hline
		9 & 5d92a123-b3a8-4f6d-b449-dc07913f60be & 2 \\  \hline
	\end{tabularx}
\end{table}

Тест был успешно пройден.
\subsection{Получение всех значений очереди}
Запрос вида \texttt{select * from getTasksReady(null);}.

Ожидание: будут получены все значения из исходного отношения.

Результат приведен в таблице~\ref{t:document_queues_test_1}.

\begin{table}[h]
	\centering
	\caption{Результаты получения всех значений из исходного отношения}
	\label{t:document_queues_test_1}
	\begin{tabularx}{\textwidth}{|c|Z|c|}
		 \hline
		\textbf{ID} & \textbf{doc\_id} & \textbf{status}  \\ \hline
		1 & 710eb9fc-1118-4a66-837e-8e3d2d027a68 & 0 \\ \hline
		2 & 710eb9fc-1118-4a66-837e-8e3d2d027a67 & 0 \\ \hline
		3 & 710eb9fc-1118-4a66-837e-8e3d2d027a65 & 0 \\ \hline
		4 & 710eb9fc-1118-4a66-837e-8e3d2d027a61 & 0 \\ \hline
		5 & 5d92a123-b3a8-4f6d-b449-dc07913f60be & 0 \\ \hline 
		7 & df6286ba-9993-4a15-928b-2ef0652dd699 & 1 \\ \hline
		9 & 5d92a123-b3a8-4f6d-b449-dc07913f60be & 2 \\  \hline
	\end{tabularx}
\end{table}

\subsection{Получение значений очереди в соответствии со статусом}
Запрос вида \texttt{select * from getTasksReady(1::int2);}.

Ожидание: будут получены элементы отношения со статусом равным 1.

Результат приведен в таблице~\ref{t:document_queues_test_2}.
\begin{table}[h]
	\centering
	\caption{Результат получения элементов из отношения со статусом 1 }
	\label{t:document_queues_test_2}
	\begin{tabularx}{\textwidth}{|c|Z|c|} \hline
		\textbf{ID} & \textbf{doc\_id} & \textbf{status}  \\ \hline
		7 & df6286ba-9993-4a15-928b-2ef0652dd699 & 1 \\ \hline
	\end{tabularx}
\end{table}
Тест был успешно пройден.

Запрос вида \texttt{select * from getTasksReady(2::int2);}.

Ожидание: будут получены элементы отношения со статусом равным 2.

Результат приведен в таблице~\ref{t:document_queues_test_3}.
\begin{table}[H]
	\centering
	\caption{Результат получения элементов из отношения со статусом 1 }
	\label{t:document_queues_test_3}
	\begin{tabularx}{\textwidth}{|c|Z|c|} \hline
		\textbf{ID} & \textbf{doc\_id} & \textbf{status} \\ \hline
		9 & 5d92a123-b3a8-4f6d-b449-dc07913f60be & 2 \\ \hline
	\end{tabularx}
\end{table}
Тест был успешно пройден.

Запрос вида \texttt{select * from getTasksReady(0::int2);}.

Ожидание: будут получены элементы отношения со статусом равным 0.

Результат приведен в таблице~\ref{t:document_queues_test_4}.

\begin{table}[H]
	\centering
	\caption{Результат получения элементов из отношения со статусом 0}
	\label{t:document_queues_test_4}
	\begin{tabularx}{\textwidth}{|c|Z|c|} 
	 \hline
	\textbf{ID} & \textbf{doc\_id} & \textbf{status}  \\ \hline
	1 & 710eb9fc-1118-4a66-837e-8e3d2d027a68 & 0 \\ \hline
	2 & 710eb9fc-1118-4a66-837e-8e3d2d027a67 & 0 \\ \hline
	3 & 710eb9fc-1118-4a66-837e-8e3d2d027a65 & 0 \\ \hline
	4 & 710eb9fc-1118-4a66-837e-8e3d2d027a61 & 0 \\ \hline
	5 & 5d92a123-b3a8-4f6d-b449-dc07913f60be & 0 \\ \hline 
	\end{tabularx}
\end{table}
Тест был успешно пройден.

\subsection{Тестирование разработанных триггеров базы данных}
Воспользуемся отношением очереди, представленном в таблице~\ref{t:document_queues_test_def}.
Рассмотрим следующие варианты использования разработанного триггера \texttt{addToQueue}:
\begin{enumerate}
	\item Попытка загрузки документа с подстрокой <<VIP>> в названии.
	\item Попытка загрузки документа  без подстроки <<VIP>>.
\end{enumerate}

\subsection{Попытка загрузки документа с рассматриваемой подстрокой}

Вид запроса представлен в листинге~\ref{lst:ins_VIP}
\begin{lstlisting}[caption=Запрос загрузки документа с подстрокой <<VIP>>,frame=tlrb,label=lst:ins_VIP]
INSERT INTO documents (id,page_count, document_name, checks_count, creator_id, creation_time, has_passed)
VALUES ('04570f8a-1f94-4e62-9fbd-02a7beb8ba24',10, 'VIP_Document', 5, 2, '2024-05-20 12:00:00', true)
\end{lstlisting}

Ожидание: Отношение очереди останется неизменным.

Результат состояние очереди осталось неизменным.

Тест был успешно пройден.
\subsection{Попытка загрузки документа без рассматриваемой подстроки}
Ожидание: в очереди появится новый документ.

Вид запроса представлен в листинге~\ref{lst:ins_not_VIP}
Состояние очереди после запроса представлено в таблице~\ref{t:document_queues_ins_not_VIP}.

\begin{lstlisting}[caption=Запрос загрузки документа без подстоки <<VIP>>,frame=tlrb,label=lst:ins_not_VIP]
	
	INSERT INTO documents (id,page_count, document_name, checks_count, creator_id, creation_time, has_passed)
	VALUES ('99c50e01-8c64-4766-9cdb-9ff087486a5d',10, 'SOME_Document', 5, 2, '2024-05-20 12:00:00', true)
\end{lstlisting}

\begin{table}[h]
	\centering
	\caption{Таблица отношения очереди после добавления документа}
	\label{t:document_queues_ins_not_VIP}
	\begin{tabularx}{\textwidth}{|c|Z|c|}
		\hline
		\textbf{ID} & \textbf{doc\_id} & \textbf{status}  \\ \hline
		1 & 710eb9fc-1118-4a66-837e-8e3d2d027a68 & 0 \\ \hline
		2 & 710eb9fc-1118-4a66-837e-8e3d2d027a67 & 0 \\ \hline
		3 & 710eb9fc-1118-4a66-837e-8e3d2d027a65 & 0 \\ \hline
		4 & 710eb9fc-1118-4a66-837e-8e3d2d027a61 & 0 \\ \hline
		5 & 5d92a123-b3a8-4f6d-b449-dc07913f60be & 0 \\ \hline 
		7 & df6286ba-9993-4a15-928b-2ef0652dd699 & 1 \\ \hline
		9 & 5d92a123-b3a8-4f6d-b449-dc07913f60be & 2 \\  \hline
		11 &	99c50e01-8c64-4766-9cdb-9ff087486a5d &	0 \\ \hline
	\end{tabularx}
\end{table}

Тест был успешно пройден.

\section{Реализация приложения}
При загрузке документа сначала сохраняется сам файл документа, после чего в базу данных записываются метаданные файла (время отправки, число проверок, имя файла). После чего данные отправляются на сервер тестирования, где каждая страница отчета преобразуется в файл портативной сетевой графики (англ.  Portable network graphic, сокр. png). После чего на каждой странице решается задача детекции с помощью нейросети YOLOv8~\cite{YOLOv8}. После чего каждый из детектируемых изображений попадает  на обработку списку обработчиков, которые,  в зависимости от класса изображения(полученного до этого в задаче детекции) осуществляют проверку по соответствующим критериям. В случае указания постфикса VIP при загрузке файла считается что файл проверяется вне очереди и будет проверен системой сразу, иначе он будет добавлен в очередь файлов и помечен как готовый к проверке (поле status), после чего он будет проверен системой при запуска программы с помощью утилиты cron~\cite{cron}.

На рисунке~\ref{img:systems_integr}, представлена диаграмма последовательности действий при работе системы.
\includeimage
{systems_integr} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{H} % Положение рисунка (см. figure из пакета float)
{1\textwidth} % Ширина рисунка
{Диаграмма последовательности действий получение отчета об ошибках работы студента} % Подпись рисунка





\section{Описание программного интерфейса}
Для описания интерфейса взаимодействия с приложением была использована библиотека go-swagger, а также приложение postman~\cite{go-swagger,postman}. На рисунках~\ref{img:app_inter_1}--\ref{img:app_inter_2}, представлен интерфейс доступа к сущностям базы данных.

Для взаимодействия с типами фрагментов необходима роль нормоконтроллера или админа, в интерфейсе предоставлены следующие операции:
\begin{enumerate}
	\item Создание нового типа фрагментов.
	\item Получение всех типов фрагментов, созданных текущим вошедшим в систему пользователем.
	\item Удаление типа фрагмента по его уникальному идентификатору, данная операцию может совершить только пользователь с ролью <<админ>>.
	\item Получение нескольких фрагментов по их уникальным идентификаторам.
	\item Получение всех существующих в базе данных типов фрагментов.
\end{enumerate}

Для взаимодействия с фрагментами необходима роль нормоконтроллера или админа, в интерфейсе предоставлены следующие операции:
\begin{enumerate}
	\item Создание нового фрагмента.
	\item Регистрация проверки данного фрагмента для его валидации.
	\item Получение всех существующих в базе данных типов фрагментов.
	\item Получение всех фрагментов, созданных текущим вошедшим в систему пользователем.
	\item Получение фрагмента по его уникальному идентификатору.
\end{enumerate}

Для взаимодействия с документами представлены следующие операции:
\begin{enumerate}
	\item Получение файла документа по уникальному идентификатору.
	\item Получение метаданных обо всех документах, созданных текущем пользователем.
	\item Принятие решения о верности данного документа или нет (нормоконтроллер принял документ).
	\item Создание и сохранение отчета об ошибках, метаданных и файла документа в системе.
	\item Получение файла отчета об ошибках по уникальному идентификатору (уникальные идентификаторы документа и отчета по нему совпадают).
\end{enumerate}

Для регистрации пользователей представлены следующие операции:
\begin{enumerate}
	\item Зарегистрироваться в системе (по умолчанию выдается роль студента).
	\item Войти в систему с использованными при регистрации данными.
\end{enumerate}
По умолчанию при регистрации пользователь получает роль <<студент>>, для ее изменения необходимо, чтобы пользователь с ролью <<админ>> изменил его роль.

Для взаимодействия с пользователями необходима роль пользователя <<админ>> ,в интерфейсе представлены следующие операции:
\begin{enumerate}
	\item Получение всей информации о пользователях зарегистрированных в системе.
	\item Изменение роли пользователя по его уникальному логину.
\end{enumerate}



\includeimage
{app_inter_1} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{H} % Положение рисунка (см. figure из пакета float)
{1\textwidth} % Ширина рисунка
{Интерфейс взаимодействия с приложением (начало)} % Подпись рисунка


\includeimage
{app_inter_2} % Имя файла без расширения (файл должен быть расположен в директории inc/img/)
{f} % Обтекание (без обтекания)
{H} % Положение рисунка (см. figure из пакета float)
{1\textwidth} % Ширина рисунка
{Интерфейс взаимодействия с приложением (продолжение)} % Подпись рисунка

\section*{Вывод}
В данном разделе был описан язык программирования, обоснован и совершен  выбор СУБД. А также реализована ролевая модель на уровне базы данных, описано тестирование всех разработанных на стороне базы данных функций и триггеров, а также описан интерфейс доступа к базе данных. 











